<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ale Finance Control</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Cores Base da Paleta */
            --color-neon-green: #00ff8c;
            --color-neon-green-dark: #00cc70;
            --color-purple: #8a2be2;
            --color-purple-light: #9d4edd;
            --color-white: #ffffff;
            --color-black: #000000;
            --color-light-gray-base: #f5f5f5;
            --color-medium-gray-base: #e0e0e0;
            --color-dark-gray-base: #757575;
            --color-orange-base: #ff7043;
            --color-blue-base: #2979ff;
            --color-red-base: #ff3d00;

            /* Cores Semânticas Globais (Padrão Light Theme) */
            --bg-page: var(--color-light-gray-base);
            --bg-card: var(--color-white);
            --bg-sidenav: var(--color-white);
            --bg-modal-content: var(--color-white);
            --bg-input: var(--color-white);
            --bg-ad-bar: var(--color-light-gray-base);
            --bg-consumption-chart-placeholder: var(--color-light-gray-base);
            --bg-savings-progress-container: var(--color-light-gray-base);
            --bg-sidenav-link-hover: var(--color-light-gray-base);
            --bg-modal-overlay: rgba(0, 0, 0, 0.5);

            --gradient-header: linear-gradient(135deg, var(--color-neon-green) 0%, var(--color-purple) 100%);
            --gradient-button-primary: linear-gradient(135deg, var(--color-neon-green) 0%, var(--color-purple) 100%);
            --gradient-logo-text: linear-gradient(135deg, var(--color-neon-green) 0%, var(--color-purple) 100%);
            --gradient-savings-progress: linear-gradient(90deg, var(--color-neon-green) 0%, var(--color-blue-base) 100%);
            --gradient-theme-button-active: linear-gradient(135deg, var(--color-neon-green) 0%, var(--color-purple) 100%);

            --text-primary: var(--color-dark-gray-base);
            --text-secondary: var(--color-dark-gray-base); /* Usado em labels, títulos de card menores */
            --text-on-gradient: var(--color-white);
            --text-placeholder: #a0a0a0; /* Nova para placeholders */
            --text-accent-purple: var(--color-purple);
            --text-accent-neon-green: var(--color-neon-green-dark); /* Usado para valores positivos */
            --text-accent-orange: var(--color-orange-base); /* Usado para valores negativos/gastos */
            --text-accent-blue: var(--color-blue-base); /* Usado para economias */
            --text-accent-red: var(--color-red-base); /* Usado para deletar */
            --text-sidenav-link: var(--color-dark-gray-base);
            --text-sidenav-link-active: var(--color-purple);
            --text-modal-title: var(--color-purple);
            --text-notification-badge: var(--color-white);
            --text-theme-button: var(--color-dark-gray-base);
            --text-theme-button-active: var(--color-white);
            
            --border-primary: var(--color-medium-gray-base);
            --border-input: var(--color-medium-gray-base);
            --border-input-focus: var(--color-purple);
            --shadow-input-focus: 0 0 0 2px rgba(138, 43, 226, 0.2);
            --border-theme-button: var(--color-medium-gray-base);

            --fill-icon-header: var(--color-white);
            --fill-icon-default: var(--color-dark-gray-base); /* Para ícones como close, back */
            --fill-icon-accent-display: var(--color-neon-green); /* Edit icon on main summary card */
            --fill-icon-accent-interactive: var(--color-purple); /* Back button */
            --fill-icon-on-primary-bg: var(--color-white); /* Floating add button */
            --fill-icon-current-color: currentColor; /* Para ícones que herdam cor do texto */

            --shadow-header: 0 2px 10px rgba(0, 0, 0, 0.1);
            --shadow-sidenav: 2px 0 10px rgba(0, 0, 0, 0.1);
            --shadow-card-main: 0 8px 20px rgba(0, 0, 0, 0.1);
            --shadow-card-secondary: 0 4px 12px rgba(0, 0, 0, 0.05); /* Quick access, forms, settings */
            --shadow-card-secondary-hover: 0 6px 16px rgba(0, 0, 0, 0.1);
            --shadow-button-primary-hover: 0 4px 12px rgba(138, 43, 226, 0.3);
            --shadow-floating-add-button: 0 4px 12px rgba(138, 43, 226, 0.4);
            --shadow-modal-content: 0 10px 25px rgba(0, 0, 0, 0.2);

            --quick-access-icon-income-bg: rgba(0, 255, 140, 0.15);
            --quick-access-icon-income-fg: var(--color-neon-green-dark);
            --quick-access-icon-fixed-bg: rgba(138, 43, 226, 0.15);
            --quick-access-icon-fixed-fg: var(--color-purple);
            --quick-access-icon-expenses-bg: rgba(255, 112, 67, 0.15);
            --quick-access-icon-expenses-fg: var(--color-orange-base);
            --quick-access-icon-savings-bg: rgba(41, 121, 255, 0.15);
            --quick-access-icon-savings-fg: var(--color-blue-base);

            --action-button-delete-bg: rgba(255, 61, 0, 0.1);
            --action-button-delete-fg: var(--color-red-base);
            --action-button-mark-bg: rgba(0, 255, 140, 0.1);
            --action-button-mark-fg: var(--color-neon-green-dark);
            --action-button-edit-bg: rgba(138, 43, 226, 0.1);
            --action-button-edit-fg: var(--color-purple);
        }

        .light-theme { /* Explicit light theme class, inherits from :root by default */ }

        .dark-theme {
            --bg-page: #121212;
            --bg-card: #1E1E1E;
            --bg-sidenav: #1E1E1E;
            --bg-modal-content: #2A2A2A;
            --bg-input: #2A2A2A;
            --bg-ad-bar: #1E1E1E;
            --bg-consumption-chart-placeholder: #2A2A2A;
            --bg-savings-progress-container: #2A2A2A;
            --bg-sidenav-link-hover: #2C2C2C;
            --bg-modal-overlay: rgba(0, 0, 0, 0.7);

            --text-primary: #E0E0E0;
            --text-secondary: #B0B0B0;
            --text-placeholder: #707070;
            --text-accent-purple: var(--color-purple-light);
            --text-accent-neon-green: var(--color-neon-green); 
            --text-accent-orange: #FF8A65; 
            --text-accent-blue: #69AAFF; 
            --text-accent-red: #FF5252; 
            --text-sidenav-link: #C0C0C0;
            --text-sidenav-link-active: var(--color-purple-light);
            --text-modal-title: var(--color-purple-light);
            --text-theme-button: #E0E0E0;

            --border-primary: #3A3A3A;
            --border-input: #4A4A4A;
            --border-input-focus: var(--color-purple-light);
            --shadow-input-focus: 0 0 0 2px rgba(157, 78, 221, 0.3);
            --border-theme-button: #4A4A4A;

            --fill-icon-default: #C0C0C0;
            --fill-icon-accent-interactive: var(--color-purple-light);

            --shadow-header: 0 2px 10px rgba(0, 0, 0, 0.3);
            --shadow-sidenav: 2px 0 10px rgba(0, 0, 0, 0.3);
            --shadow-card-main: 0 8px 20px rgba(0, 0, 0, 0.25);
            --shadow-card-secondary: 0 4px 12px rgba(0, 0, 0, 0.2);
            --shadow-card-secondary-hover: 0 6px 16px rgba(0, 0, 0, 0.25);
            --shadow-button-primary-hover: 0 4px 12px rgba(157, 78, 221, 0.4);
            --shadow-floating-add-button: 0 4px 12px rgba(157, 78, 221, 0.5);
            --shadow-modal-content: 0 10px 25px rgba(0, 0, 0, 0.4);

            --quick-access-icon-income-bg: rgba(0, 255, 140, 0.2);
            --quick-access-icon-income-fg: var(--color-neon-green);
            --quick-access-icon-fixed-bg: rgba(157, 78, 221, 0.2);
            --quick-access-icon-fixed-fg: var(--color-purple-light);
            --quick-access-icon-expenses-bg: rgba(255, 138, 101, 0.2);
            --quick-access-icon-expenses-fg: #FF8A65;
            --quick-access-icon-savings-bg: rgba(105, 170, 255, 0.2);
            --quick-access-icon-savings-fg: #69AAFF;
            
            --action-button-delete-bg: rgba(255, 82, 82, 0.2);
            --action-button-delete-fg: #FF5252;
            --action-button-mark-bg: rgba(0, 255, 140, 0.2);
            --action-button-mark-fg: var(--color-neon-green);
            --action-button-edit-bg: rgba(157, 78, 221, 0.2);
            --action-button-edit-fg: var(--color-purple-light);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background-color: var(--bg-page); color: var(--text-primary); position: relative; min-height: 100vh; padding-bottom: 70px; transition: background-color 0.3s ease, color 0.3s ease; }
        #appHeader { height: 56px; background: var(--gradient-header); color: var(--text-on-gradient); display: flex; justify-content: space-between; align-items: center; padding: 0 16px; position: fixed; top: 0; left: 0; right: 0; z-index: 100; box-shadow: var(--shadow-header); }
        .header-button { background: none; border: none; color: var(--text-on-gradient); cursor: pointer; position: relative; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
        .header-button svg { width: 24px; height: 24px; fill: var(--fill-icon-header); }
        .notification-badge { position: absolute; top: 0; right: 0; background-color: var(--text-accent-red); color: var(--text-notification-badge); border-radius: 50%; width: 16px; height: 16px; font-size: 10px; display: none; align-items: center; justify-content: center; } /* Initially hidden */
        .welcome-text { font-weight: 500; font-size: 16px; color: var(--text-on-gradient); }
        #appSidenav { position: fixed; top: 0; left: -280px; width: 280px; height: 100%; background-color: var(--bg-sidenav); z-index: 200; box-shadow: var(--shadow-sidenav); transition: left 0.3s ease, background-color 0.3s ease; padding: 20px 0; overflow-y: auto; }
        #appSidenav.open { left: 0; }
        .sidenav-header { display: flex; justify-content: space-between; align-items: center; padding: 0 20px 20px; border-bottom: 1px solid var(--border-primary); margin-bottom: 20px; }
        .logo { font-weight: 700; font-size: 18px; background: var(--gradient-logo-text); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .close-sidenav { background: none; border: none; cursor: pointer; color: var(--text-primary); display: flex; align-items: center; justify-content: center; }
        .close-sidenav svg { width: 20px; height: 20px; fill: var(--fill-icon-default); }
        .sidenav-links { list-style: none; }
        .sidenav-link { display: flex; align-items: center; padding: 15px 20px; color: var(--text-sidenav-link); text-decoration: none; transition: background-color 0.2s, color 0.2s; }
        .sidenav-link:hover, .sidenav-link.active { background-color: var(--bg-sidenav-link-hover); color: var(--text-sidenav-link-active); }
        .sidenav-link-icon { margin-right: 15px; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; }
        .sidenav-link-icon svg { width: 20px; height: 20px; fill: var(--fill-icon-current-color); }
        #appContainer { padding: 76px 16px 20px; max-width: 800px; margin: 0 auto; }
        #adBarFixedBottom { position: fixed; bottom: 0; left: 0; right: 0; height: 70px; background-color: var(--bg-ad-bar); border-top: 1px solid var(--border-primary); display: flex; align-items: center; justify-content: center; z-index: 90; transition: background-color 0.3s ease, border-color 0.3s ease; }
        #adBarFixedBottom div { color: var(--text-secondary); }
        .main-summary-card { background-color: var(--bg-card); border-radius: 16px; box-shadow: var(--shadow-card-main); padding: 20px; margin-bottom: 24px; animation: fadeInUp 0.6s ease; transition: background-color 0.3s ease, box-shadow 0.3s ease; }
        .main-summary-card-title { color: var(--text-secondary); font-size: 14px; font-weight: 500; margin-bottom: 8px; }
        .main-summary-card-value { font-size: 28px; font-weight: 700; color: var(--text-accent-purple); display: flex; justify-content: space-between; align-items: center; }
        .edit-icon { background: none; border: none; color: var(--fill-icon-accent-display); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .edit-icon svg { width: 18px; height: 18px; fill: var(--fill-icon-accent-display); }
        .quick-access-cards-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 24px; }
        .quick-access-card { background-color: var(--bg-card); border-radius: 12px; padding: 16px; box-shadow: var(--shadow-card-secondary); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s, background-color 0.3s ease; animation: fadeInUp 0.6s ease; animation-fill-mode: both; }
        .quick-access-card:nth-child(1) { animation-delay: 0.1s; } .quick-access-card:nth-child(2) { animation-delay: 0.2s; } .quick-access-card:nth-child(3) { animation-delay: 0.3s; } .quick-access-card:nth-child(4) { animation-delay: 0.4s; }
        .quick-access-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-card-secondary-hover); }
        .card-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 12px; } .card-icon svg { width: 20px; height: 20px; }
        .card-icon.income { background-color: var(--quick-access-icon-income-bg); color: var(--quick-access-icon-income-fg); } .card-icon.income svg { fill: var(--quick-access-icon-income-fg); }
        .card-icon.fixed { background-color: var(--quick-access-icon-fixed-bg); color: var(--quick-access-icon-fixed-fg); } .card-icon.fixed svg { fill: var(--quick-access-icon-fixed-fg); }
        .card-icon.expenses { background-color: var(--quick-access-icon-expenses-bg); color: var(--quick-access-icon-expenses-fg); } .card-icon.expenses svg { fill: var(--quick-access-icon-expenses-fg); }
        .card-icon.savings { background-color: var(--quick-access-icon-savings-bg); color: var(--quick-access-icon-savings-fg); } .card-icon.savings svg { fill: var(--quick-access-icon-savings-fg); }
        .card-title { font-size: 14px; font-weight: 500; color: var(--text-secondary); margin-bottom: 4px; } .card-value { font-size: 16px; font-weight: 600; }
        .card-value.income { color: var(--text-accent-neon-green); } .card-value.fixed { color: var(--text-accent-purple); } .card-value.expenses { color: var(--text-accent-orange); } .card-value.savings { color: var(--text-accent-blue); }
        .consumption-summary-card { background-color: var(--bg-card); border-radius: 16px; box-shadow: var(--shadow-card-secondary); padding: 20px; animation: fadeInUp 0.6s ease 0.5s both; transition: background-color 0.3s ease, box-shadow 0.3s ease; }
        .consumption-chart-placeholder { height: 150px; background-color: var(--bg-consumption-chart-placeholder); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); margin-bottom: 16px; transition: background-color 0.3s ease; }
        .consumption-totals { display: flex; justify-content: space-between; } .consumption-total-item { text-align: center; } .consumption-total-label { font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; } .consumption-total-value { font-size: 16px; font-weight: 600; }
        .consumption-total-value.spent { color: var(--text-accent-orange); } .consumption-total-value.remaining { color: var(--text-accent-neon-green); }
        .page-header-generic { display: flex; align-items: center; margin-bottom: 20px; }
        .back-button { background: none; border: none; color: var(--text-accent-purple); cursor: pointer; margin-right: 16px; display: flex; align-items: center; justify-content: center; }
        .back-button svg { width: 24px; height: 24px; fill: var(--fill-icon-accent-interactive); }
        .page-title { font-size: 20px; font-weight: 600; color: var(--text-accent-purple); }
        .styled-form { background-color: var(--bg-card); border-radius: 16px; padding: 20px; box-shadow: var(--shadow-card-secondary); margin-bottom: 24px; transition: background-color 0.3s ease, box-shadow 0.3s ease; }
        .form-group { margin-bottom: 16px; } .form-label { display: block; font-size: 14px; font-weight: 500; color: var(--text-secondary); margin-bottom: 8px; }
        .form-input { width: 100%; padding: 12px 16px; border: 1px solid var(--border-input); background-color: var(--bg-input); color: var(--text-primary); border-radius: 8px; font-size: 14px; transition: border 0.3s, background-color 0.3s, color 0.3s; }
        .form-input::placeholder { color: var(--text-placeholder); }
        .form-input:focus { outline: none; border-color: var(--border-input-focus); box-shadow: var(--shadow-input-focus); }
        .primary-button { background: var(--gradient-button-primary); color: var(--text-on-gradient); border: none; border-radius: 8px; padding: 12px 24px; font-size: 16px; font-weight: 500; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; width: 100%; }
        .primary-button:hover { transform: translateY(-2px); box-shadow: var(--shadow-button-primary-hover); }
        .item-list-container { margin-top: 20px; }
        .item-card { background-color: var(--bg-card); border-radius: 12px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 12px; transition: background-color 0.3s ease, box-shadow 0.3s ease; }
        .dark-theme .item-card { box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
        .item-header { display: flex; justify-content: space-between; margin-bottom: 8px; } .item-title { font-weight: 600; font-size: 16px; color: var(--text-accent-purple); } .item-value { font-weight: 600; font-size: 16px; color: var(--text-primary); }
        .item-details { font-size: 14px; color: var(--text-secondary); margin-bottom: 12px; } .item-actions { display: flex; gap: 8px; }
        .action-button { padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 500; cursor: pointer; border: none; display: flex; align-items: center; gap: 4px; transition: background-color 0.2s, color 0.2s; }
        .action-button svg { width: 12px; height: 12px; fill: var(--fill-icon-current-color); }
        .action-button.delete { background-color: var(--action-button-delete-bg); color: var(--action-button-delete-fg); } .action-button.mark { background-color: var(--action-button-mark-bg); color: var(--action-button-mark-fg); } .action-button.edit { background-color: var(--action-button-edit-bg); color: var(--action-button-edit-fg); }
        .floating-add-button { position: fixed; bottom: 90px; right: 20px; width: 56px; height: 56px; border-radius: 50%; background: var(--gradient-button-primary); color: var(--text-on-gradient); display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-floating-add-button); cursor: pointer; z-index: 80; border: none; }
        .floating-add-button svg { width: 24px; height: 24px; fill: var(--fill-icon-on-primary-bg); }
        .savings-summary { background-color: var(--bg-card); border-radius: 16px; padding: 20px; box-shadow: var(--shadow-card-secondary); margin-bottom: 24px; text-align: center; transition: background-color 0.3s ease, box-shadow 0.3s ease; }
        .savings-total-label { font-size: 14px; color: var(--text-secondary); margin-bottom: 8px; } .savings-total-value { font-size: 24px; font-weight: 700; color: var(--text-accent-blue); }
        .savings-item { background-color: var(--bg-card); border-radius: 12px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 16px; transition: background-color 0.3s ease, box-shadow 0.3s ease; }
        .dark-theme .savings-item { box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
        .savings-item-header { display: flex; justify-content: space-between; margin-bottom: 8px; } .savings-item-title { font-weight: 600; font-size: 16px; color: var(--text-accent-blue); } .savings-item-value { font-weight: 600; font-size: 16px; color: var(--text-primary); }
        .savings-progress-container { height: 8px; background-color: var(--bg-savings-progress-container); border-radius: 4px; margin: 12px 0; overflow: hidden; transition: background-color 0.3s ease; }
        .savings-progress-bar { height: 100%; background: var(--gradient-savings-progress); border-radius: 4px; transition: width 0.3s ease; }
        .investment-simulator { background-color: var(--bg-card); border-radius: 16px; padding: 20px; box-shadow: var(--shadow-card-secondary); margin-top: 24px; text-align: center; color: var(--text-secondary); transition: background-color 0.3s ease, box-shadow 0.3s ease, color 0.3s ease; }
        .settings-group { background-color: var(--bg-card); border-radius: 16px; padding: 20px; box-shadow: var(--shadow-card-secondary); margin-bottom: 24px; transition: background-color 0.3s ease, box-shadow 0.3s ease; }
        .settings-group-title { font-size: 16px; font-weight: 600; color: var(--text-accent-purple); margin-bottom: 16px; }
        .theme-buttons { display: flex; gap: 8px; margin-bottom: 12px; }
        .theme-button { padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; border: 1px solid var(--border-theme-button); background-color: var(--bg-card); color: var(--text-theme-button); display: flex; align-items: center; gap: 6px; transition: background-color 0.2s, color 0.2s, border-color 0.2s; }
        .theme-button svg { width: 16px; height: 16px; fill: var(--fill-icon-current-color); }
        .theme-button.active { background: var(--gradient-theme-button-active); color: var(--text-theme-button-active); border: none; }
        .theme-status { font-size: 14px; color: var(--text-secondary); } .about-item { margin-bottom: 8px; } .about-label { font-size: 14px; color: var(--text-secondary); } .about-value { font-size: 14px; font-weight: 500; color: var(--text-primary); }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--bg-modal-overlay); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s, background-color 0.3s ease; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--bg-modal-content); border-radius: 16px; width: 90%; max-width: 400px; max-height: 90vh; overflow-y: auto; padding: 24px; box-shadow: var(--shadow-modal-content); transform: translateY(20px); opacity: 0; transition: transform 0.3s, opacity 0.3s, background-color 0.3s ease, box-shadow 0.3s ease; }
        .modal-overlay.active .modal-content { transform: translateY(0); opacity: 1; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; } .modal-title { font-size: 18px; font-weight: 600; color: var(--text-modal-title); }
        .modal-close { background: none; border: none; color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .modal-close svg { width: 20px; height: 20px; fill: var(--fill-icon-default); }
        .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--bg-modal-overlay); z-index: 150; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s, background-color 0.3s ease; }
        .overlay.active { opacity: 1; visibility: visible; }
        .app-screen { display: none; } .app-screen.active { display: block; }

        /* Notification Sidenav */
        #appNotificationSidenav { position: fixed; top: 0; right: -300px; width: 300px; height: 100%; background-color: var(--bg-sidenav); z-index: 250; box-shadow: -2px 0 10px rgba(0,0,0,0.1); transition: right 0.3s ease, background-color 0.3s ease; display: flex; flex-direction: column; }
        #appNotificationSidenav.open { right: 0; }
        .notification-sidenav-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid var(--border-primary); }
        .notification-sidenav-title { font-size: 18px; font-weight: 600; color: var(--text-accent-purple); }
        .close-notification-sidenav { background: none; border: none; cursor: pointer; color: var(--text-primary); display: flex; align-items: center; justify-content: center; }
        .close-notification-sidenav svg { width: 20px; height: 20px; fill: var(--fill-icon-default); }
        .notification-list-container { flex-grow: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
        .notification-card { background-color: var(--bg-card); border-radius: 8px; padding: 12px; box-shadow: var(--shadow-card-secondary); border-left: 4px solid var(--color-purple); cursor: pointer; transition: background-color 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease; }
        .notification-card.is-read { opacity: 0.7; border-left-color: var(--border-primary); }
        .notification-card:hover { box-shadow: var(--shadow-card-secondary-hover); }
        .notification-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .notification-card-title { font-size: 14px; font-weight: 600; color: var(--text-primary); }
        .notification-card-time { font-size: 10px; color: var(--text-secondary); }
        .notification-card-message { font-size: 12px; color: var(--text-secondary); margin-bottom: 8px; line-height: 1.4; }
        .notification-card-actions { text-align: right; }
        .notification-card-actions .action-button { padding: 4px 8px; font-size: 10px; }
        .notification-empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; color: var(--text-secondary); }
        .notification-empty-state svg { width: 48px; height: 48px; fill: var(--fill-icon-default); margin-bottom: 16px; opacity: 0.5; }
        .notification-sidenav-footer { padding: 16px; border-top: 1px solid var(--border-primary); }
        .secondary-button { background-color: var(--bg-card); color: var(--text-accent-purple); border: 1px solid var(--text-accent-purple); border-radius: 8px; padding: 10px 20px; font-size: 14px; font-weight: 500; cursor: pointer; transition: background-color 0.2s, color 0.2s; width: 100%; }
        .dark-theme .secondary-button { background-color: var(--bg-card); color: var(--text-accent-purple); border: 1px solid var(--text-accent-purple); }
        .secondary-button:hover { background-color: var(--text-accent-purple); color: var(--bg-card); }
        .dark-theme .secondary-button:hover { color: var(--bg-card); }
        #notificationOverlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--bg-modal-overlay); z-index: 240; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        #notificationOverlay.active { opacity: 1; visibility: visible; }
    </style>
</head>
<body>
    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
        <symbol id="icon-menu" viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path></symbol>
        <symbol id="icon-notification" viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z"></path></symbol>
        <symbol id="icon-close" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></symbol>
        <symbol id="icon-home" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"></path></symbol>
        <symbol id="icon-income" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"></path></symbol>
        <symbol id="icon-fixed" viewBox="0 0 24 24"><path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"></path></symbol>
        <symbol id="icon-expenses" viewBox="0 0 24 24"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"></path></symbol>
        <symbol id="icon-savings" viewBox="0 0 24 24"><path d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"></path></symbol>
        <symbol id="icon-settings" viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"></path></symbol>
        <symbol id="icon-back" viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></symbol>
        <symbol id="icon-edit" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"></path></symbol>
        <symbol id="icon-delete" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"></path></symbol>
        <symbol id="icon-check" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"></path></symbol>
        <symbol id="icon-add" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></symbol>
        <symbol id="icon-sun" viewBox="0 0 24 24"><path d="M6.76 4.84l-1.8-1.79-1.41 1.41 1.79 1.79 1.42-1.41zM4 10.5H1v2h3v-2zm9-9.95h-2V3.5h2V.55zm7.45 3.91l-1.41-1.41-1.79 1.79 1.41 1.41 1.79-1.79zm-3.21 13.7l1.79 1.8 1.41-1.41-1.8-1.79-1.4 1.4zM20 10.5v2h3v-2h-3zm-8-5c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm-1 16.95h2V19.5h-2v2.95zm-7.45-3.91l1.41 1.41 1.79-1.8-1.41-1.41-1.79 1.8z"></path></symbol>
        <symbol id="icon-moon" viewBox="0 0 24 24"><path d="M10 2c-1.82 0-3.53.5-5 1.35C7.99 5.08 10 8.3 10 12s-2.01 6.92-5 8.65C6.47 21.5 8.18 22 10 22c5.52 0 10-4.48 10-10S15.52 2 10 2z"></path></symbol>
        <symbol id="icon-auto" viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"></path></symbol>
    </svg>

    <header id="appHeader">
        <button class="header-button" id="menuButton"><svg><use xlink:href="#icon-menu"></use></svg></button>
        <div class="welcome-text">Bem-vindo, Usuário!</div>
        <button class="header-button" id="notificationButton">
            <svg><use xlink:href="#icon-notification"></use></svg>
            <span class="notification-badge"></span>
        </button>
    </header>

    <nav id="appSidenav">
        <div class="sidenav-header">
            <div class="logo">Ale Finance Control</div>
            <button class="close-sidenav" id="closeSidenavButton"><svg><use xlink:href="#icon-close"></use></svg></button>
        </div>
        <ul class="sidenav-links">
            <li><a href="#" class="sidenav-link active" data-screen="dashboard"><span class="sidenav-link-icon"><svg><use xlink:href="#icon-home"></use></svg></span> Início</a></li>
            <li><a href="#" class="sidenav-link" data-screen="income"><span class="sidenav-link-icon"><svg><use xlink:href="#icon-income"></use></svg></span> Minhas Receitas</a></li>
            <li><a href="#" class="sidenav-link" data-screen="fixed-expenses"><span class="sidenav-link-icon"><svg><use xlink:href="#icon-fixed"></use></svg></span> Contas Fixas</a></li>
            <li><a href="#" class="sidenav-link" data-screen="expenses"><span class="sidenav-link-icon"><svg><use xlink:href="#icon-expenses"></use></svg></span> Meus Gastos</a></li>
            <li><a href="#" class="sidenav-link" data-screen="savings"><span class="sidenav-link-icon"><svg><use xlink:href="#icon-savings"></use></svg></span> Guardar Dinheiro</a></li>
            <li><a href="#" class="sidenav-link" data-screen="settings"><span class="sidenav-link-icon"><svg><use xlink:href="#icon-settings"></use></svg></span> Configurações</a></li>
        </ul>
    </nav>

    <div class="overlay" id="overlay"></div>

    <main id="appContainer">
        <section class="app-screen active" id="dashboard">
            <div class="main-summary-card">
                <div class="main-summary-card-title">Minha Renda Mensal Total</div>
                <div class="main-summary-card-value">
                    <span>R$ 0,00</span>
                    <button class="edit-icon" id="editIncomeButton">
                        <svg><use xlink:href="#icon-edit"></use></svg>
                    </button>
                </div>
            </div>
            <div class="quick-access-cards-container">
                <div class="quick-access-card" data-screen="income">
                    <div class="card-icon income"><svg><use xlink:href="#icon-income"></use></svg></div>
                    <div class="card-title">Minhas Receitas</div>
                    <div class="card-value income">+ R$ 0,00</div>
                </div>
                <div class="quick-access-card" data-screen="fixed-expenses">
                    <div class="card-icon fixed"><svg><use xlink:href="#icon-fixed"></use></svg></div>
                    <div class="card-title">Contas Fixas</div>
                    <div class="card-value fixed">R$ 0,00 /mês</div>
                </div>
                <div class="quick-access-card" data-screen="expenses">
                    <div class="card-icon expenses"><svg><use xlink:href="#icon-expenses"></use></svg></div>
                    <div class="card-title">Meus Gastos</div>
                    <div class="card-value expenses">- R$ 0,00</div>
                </div>
                <div class="quick-access-card" data-screen="savings">
                    <div class="card-icon savings"><svg><use xlink:href="#icon-savings"></use></svg></div>
                    <div class="card-title">Guardar Dinheiro</div>
                    <div class="card-value savings">R$ 0,00</div>
                </div>
            </div>
            <div class="consumption-summary-card">
                <div class="consumption-chart-placeholder">Gráfico de Gastos</div>
                <div class="consumption-totals">
                    <div class="consumption-total-item">
                        <div class="consumption-total-label">Total Gasto</div>
                        <div class="consumption-total-value spent">R$ 0,00</div>
                    </div>
                    <div class="consumption-total-item">
                        <div class="consumption-total-label">Renda Restante</div>
                        <div class="consumption-total-value remaining">R$ 0,00</div>
                    </div>
                </div>
            </div>
        </section>

        <section class="app-screen" id="income">
            <div class="page-header-generic">
                <button class="back-button" data-screen="dashboard"><svg><use xlink:href="#icon-back"></use></svg></button>
                <h2 class="page-title">Minhas Receitas</h2>
            </div>
            <form class="styled-form">
                <div class="form-group">
                    <label class="form-label" for="incomeName">Nome da Receita</label>
                    <input type="text" id="incomeName" class="form-input" placeholder="Ex: Salário">
                </div>
                <div class="form-group">
                    <label class="form-label" for="incomeValue">Valor (R$)</label>
                    <input type="number" id="incomeValue" class="form-input" placeholder="0,00" step="0.01">
                </div>
                <div class="form-group">
                    <label class="form-label" for="incomeDate">Data de Recebimento</label>
                    <input type="date" id="incomeDate" class="form-input">
                </div>
                <button type="button" class="primary-button" id="addIncomeButton">Adicionar Receita</button>
            </form>
            <div class="item-list-container" id="incomeList"><div class="item-card">Nenhuma receita cadastrada.</div></div>
        </section>

        <section class="app-screen" id="fixed-expenses">
            <div class="page-header-generic">
                <button class="back-button" data-screen="dashboard"><svg><use xlink:href="#icon-back"></use></svg></button>
                <h2 class="page-title">Contas Fixas</h2>
            </div>
            <form class="styled-form">
                <div class="form-group">
                    <label class="form-label" for="fixedExpenseName">Nome da Conta</label>
                    <input type="text" id="fixedExpenseName" class="form-input" placeholder="Ex: Aluguel">
                </div>
                <div class="form-group">
                    <label class="form-label" for="fixedExpenseValue">Valor (R$)</label>
                    <input type="number" id="fixedExpenseValue" class="form-input" placeholder="0,00" step="0.01">
                </div>
                <div class="form-group">
                    <label class="form-label" for="fixedExpenseDueDate">Data de Vencimento</label>
                    <input type="date" id="fixedExpenseDueDate" class="form-input">
                </div>
                <button type="button" class="primary-button" id="addFixedExpenseButton">Adicionar Conta Fixa</button>
            </form>
            <div class="item-list-container" id="fixedExpensesList"><div class="item-card">Nenhuma conta fixa cadastrada.</div></div>
        </section>

        <section class="app-screen" id="expenses">
            <div class="page-header-generic">
                <button class="back-button" data-screen="dashboard"><svg><use xlink:href="#icon-back"></use></svg></button>
                <h2 class="page-title">Meus Gastos</h2>
            </div>
            <form class="styled-form" id="addExpenseForm">
                <div class="form-group">
                    <label class="form-label" for="expenseName">Descrição do Gasto</label>
                    <input type="text" id="expenseName" class="form-input" placeholder="Ex: Supermercado">
                </div>
                <div class="form-group">
                    <label class="form-label" for="expenseValue">Valor (R$)</label>
                    <input type="number" id="expenseValue" class="form-input" placeholder="0,00" step="0.01">
                </div>
                <div class="form-group">
                    <label class="form-label" for="expenseCategory">Categoria</label>
                    <select id="expenseCategory" class="form-input">
                        <option value="food">Alimentação</option>
                        <option value="transport">Transporte</option>
                        <option value="leisure">Lazer</option>
                        <option value="health">Saúde</option>
                        <option value="education">Educação</option>
                        <option value="other">Outros</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="expenseDate">Data</label>
                    <input type="date" id="expenseDate" class="form-input">
                </div>
                <button type="button" class="primary-button" id="addExpenseButton">Adicionar Gasto</button>
            </form>
            <div class="item-list-container" id="expensesList"><div class="item-card">Nenhum gasto cadastrado.</div></div>
            <button class="floating-add-button" id="addExpenseFloatingButton"><svg><use xlink:href="#icon-add"></use></svg></button>
        </section>

        <section class="app-screen" id="savings">
            <div class="page-header-generic">
                <button class="back-button" data-screen="dashboard"><svg><use xlink:href="#icon-back"></use></svg></button>
                <h2 class="page-title">Guardar Dinheiro</h2>
            </div>
            <div class="savings-summary">
                <div class="savings-total-label">Total Guardado</div>
                <div class="savings-total-value">R$ 0,00</div>
            </div>
            <form class="styled-form" id="addSavingsForm">
                <div class="form-group">
                    <label class="form-label" for="savingsName">Nome do Cofrinho</label>
                    <input type="text" id="savingsName" class="form-input" placeholder="Ex: Viagem de Férias">
                </div>
                <div class="form-group">
                    <label class="form-label" for="savingsGoal">Meta (R$)</label>
                    <input type="number" id="savingsGoal" class="form-input" placeholder="0,00" step="0.01">
                </div>
                <div class="form-group">
                    <label class="form-label" for="savingsRecurringDay">Dia do Mês para Guardar (Opcional)</label>
                    <input type="number" id="savingsRecurringDay" class="form-input" placeholder="Ex: 5 (para dia 5 de todo mês)" min="1" max="31">
                </div>
                <div class="form-group">
                    <label class="form-label" for="savingsRecurringAmount">Valor a Guardar Mensalmente (R$, Opcional)</label>
                    <input type="number" id="savingsRecurringAmount" class="form-input" placeholder="Ex: 50,00" step="0.01">
                </div>
                <button type="button" class="primary-button" id="addSavingsButton">Criar Cofrinho</button>
            </form>
            <div class="item-list-container" id="listaCofrinhosContainer"><div class="item-card">Nenhum cofrinho cadastrado.</div></div>
            <div class="investment-simulator">
                <p>Simular Investimentos</p>
                <p>Em breve</p>
            </div>
        </section>

        <section class="app-screen" id="settings">
            <div class="page-header-generic">
                <button class="back-button" data-screen="dashboard"><svg><use xlink:href="#icon-back"></use></svg></button>
                <h2 class="page-title">Configurações</h2>
            </div>
            <div class="settings-group">
                <div class="settings-group-title">Tema do App</div>
                <div class="theme-buttons">
                    <button class="theme-button" data-theme="light"><svg><use xlink:href="#icon-sun"></use></svg> Claro</button>
                    <button class="theme-button" data-theme="dark"><svg><use xlink:href="#icon-moon"></use></svg> Escuro</button>
                    <button class="theme-button" data-theme="auto"><svg><use xlink:href="#icon-auto"></use></svg> Automático</button>
                </div>
                <div class="theme-status">Tema atual: Automático</div>
            </div>
            <div class="settings-group">
                <div class="settings-group-title">Sobre o App</div>
                <div class="about-item"><span class="about-label">Nome: </span><span class="about-value">Ale Finance Control</span></div>
                <div class="about-item"><span class="about-label">Versão: </span><span class="about-value">1.2.0 (Notificações)</span></div>
            </div>
            <div class="settings-group">
                <div class="settings-group-title">Dados Pessoais</div><p>Em breve</p>
            </div>
            <div class="settings-group">
                <div class="settings-group-title">Segurança</div><p>Em breve</p>
            </div>
        </section>
    </main>

    <aside id="appNotificationSidenav">
        <div class="notification-sidenav-header">
            <h3 class="notification-sidenav-title">Notificações</h3>
            <button class="close-notification-sidenav" id="closeNotificationSidenavButton">
                <svg><use xlink:href="#icon-close"></use></svg>
            </button>
        </div>
        <div class="notification-list-container" id="notificationListContainer">
            </div>
        <div class="notification-sidenav-footer">
            <button class="secondary-button" id="markAllNotificationsReadButton">Marcar todas como lidas</button>
        </div>
    </aside>
    <div class="overlay" id="notificationOverlay"></div>


    <div id="adBarFixedBottom">
        <div>Espaço para anúncios</div>
    </div>

    <div class="modal-overlay" id="editIncomeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Editar Renda Mensal</h3>
                <button class="modal-close" id="closeIncomeModal"><svg><use xlink:href="#icon-close"></use></svg></button>
            </div>
            <form class="styled-form" style="margin-bottom: 0; box-shadow: none; padding: 0;">
                <div class="form-group">
                    <label class="form-label" for="monthlyIncome">Renda Mensal Total (R$)</label>
                    <input type="number" id="monthlyIncome" class="form-input" placeholder="0,00" step="0.01">
                </div>
                <button type="button" class="primary-button" id="saveIncomeButton">Salvar</button>
            </form>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
            const bodyElement = document.body;
            const themeButtons = document.querySelectorAll('.theme-button');
            const themeStatusElement = document.querySelector('.theme-status');

            // Initialize app data
            let appData = {
                monthlyIncome: 0,
                incomes: [],
                fixedExpenses: [],
                expenses: [],
                savings: [
                    // Exemplo de cofrinho com contribuição recorrente:
                    // { 
                    //   id: 1622549200000, name: "Férias 2026", goal: 5000, current: 250, 
                    //   recurringContribution: { dayOfMonth: 10, amount: 150 } 
                    // }
                ],
                notifications: [], // Estrutura: {id, title, message, type, relatedId, auxInfo, createdAt, isRead, actionScreen}
                theme: 'auto' 
            };

            // --- Helper Functions ---
            function formatCurrency(value) { 
                return `R$ ${Number(value).toFixed(2).replace('.', ',')}`; 
            }

            function formatDate(dateString) { // Formata YYYY-MM-DD para DD/MM/YYYY
                if (!dateString) return '';
                const parts = dateString.split('-');
                return parts.length === 3 ? `${parts[2]}/${parts[1]}/${parts[0]}` : dateString;
            }

            function saveData() { 
                localStorage.setItem('aleFinanceData', JSON.stringify(appData)); 
            }
            
            // --- Theme System ---
            function applyTheme(preference) {
                bodyElement.classList.remove('light-theme', 'dark-theme');
                let finalThemeToApply, statusText;

                if (preference === 'auto') {
                    const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    finalThemeToApply = systemPrefersDark ? 'dark' : 'light';
                    statusText = `Automático (${systemPrefersDark ? 'Escuro do Sistema' : 'Claro do Sistema'})`;
                } else {
                    finalThemeToApply = preference;
                    statusText = preference === 'dark' ? 'Escuro' : 'Claro';
                }

                bodyElement.classList.add(finalThemeToApply + '-theme');
                if (themeStatusElement) {
                    themeStatusElement.textContent = `Tema atual: ${statusText}`;
                }
                
                themeButtons.forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.getAttribute('data-theme') === preference) {
                        btn.classList.add('active');
                    }
                });
            }

            function initializeTheme() {
                const savedPreference = appData.theme || 'auto';
                applyTheme(savedPreference);

                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                    if (appData.theme === 'auto') {
                        applyTheme('auto');
                    }
                });
                // Initial check for notifications after theme and data are ready
                checkAndGenerateNotifications();
                updateNotificationBadge();
            }
            
            // --- Data Loading ---
            if (localStorage.getItem('aleFinanceData')) {
                try {
                    const storedData = JSON.parse(localStorage.getItem('aleFinanceData'));
                    // Merge carefully, ensuring new structures like 'notifications' exist
                    appData = { 
                        ...appData, // Default structure
                        ...storedData, // Overwrite with stored data
                        notifications: storedData.notifications || [] // Ensure notifications array exists
                    };
                } catch (e) { 
                    console.error('Error loading data:', e); 
                    localStorage.removeItem('aleFinanceData'); 
                }
            }

            // --- Notification System ---
            const notificationSidenav = document.getElementById('appNotificationSidenav');
            const notificationButton = document.getElementById('notificationButton'); // Bell icon in header
            const closeNotificationSidenavButton = document.getElementById('closeNotificationSidenavButton');
            const notificationListContainer = document.getElementById('notificationListContainer');
            const notificationBadgeEl = document.querySelector('.notification-badge');
            const notificationOverlay = document.getElementById('notificationOverlay');
            const markAllNotificationsReadButton = document.getElementById('markAllNotificationsReadButton');

            function generateUniqueId() { 
                return Date.now() + Math.random().toString(36).substr(2, 9); 
            }

            function addNotification(notification) {
                const newNotification = { 
                    id: generateUniqueId(), 
                    createdAt: new Date().toISOString(), 
                    isRead: false, 
                    ...notification 
                };
                appData.notifications.unshift(newNotification); // Add to the top of the list
                updateNotificationBadge(); 
                saveData();
            }
            
            function getDaysUntil(dateString) {
                const today = new Date(); 
                today.setHours(0,0,0,0); // Normalize today
                const dueDate = new Date(dateString); // Input YYYY-MM-DD is parsed as UTC midnight
                // To compare apples to apples, make dueDate effectively local start of day
                const adjustedDueDate = new Date(dueDate.getUTCFullYear(), dueDate.getUTCMonth(), dueDate.getUTCDate());
                adjustedDueDate.setHours(0,0,0,0);
                
                const diffTime = adjustedDueDate.getTime() - today.getTime();
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            }

            function checkAndGenerateNotifications() {
                const today = new Date(); 
                const currentDay = today.getDate(); 
                const currentMonth = today.getMonth(); // 0-indexed
                const currentYear = today.getFullYear();

                // 1. Fixed Expenses Notifications
                appData.fixedExpenses.forEach(expense => {
                    if (!expense.paid) {
                        const daysUntilDue = getDaysUntil(expense.dueDate);
                        if (daysUntilDue <= 2 && daysUntilDue >= 0) { // Due in 0, 1, or 2 days
                            const notificationIdentifier = `fixed-${expense.id}-${expense.dueDate}`;
                            const notificationExists = appData.notifications.some(
                                n => n.type === 'fixedExpense' && n.auxInfo === notificationIdentifier && !n.isRead
                            );
                            if (!notificationExists) {
                                addNotification({ 
                                    title: `Conta Próxima!`, 
                                    message: `${expense.name} (${formatCurrency(expense.value)}) vence ${daysUntilDue === 0 ? 'hoje' : 'em ' + daysUntilDue + (daysUntilDue === 1 ? ' dia' : ' dias')}.`, 
                                    type: 'fixedExpense', 
                                    relatedId: expense.id, 
                                    auxInfo: notificationIdentifier, // For more robust uniqueness
                                    actionScreen: 'fixed-expenses'
                                });
                            }
                        }
                    }
                });

                // 2. Savings Goal Contribution Reminders
                appData.savings.forEach(saving => {
                    if (saving.recurringContribution && saving.recurringContribution.dayOfMonth && Number(saving.current) < Number(saving.goal)) {
                        const { dayOfMonth, amount } = saving.recurringContribution;
                        const contributionDay = parseInt(dayOfMonth, 10);
                        
                        // Notify on day itself, and 1 or 2 days before
                        const notificationDays = [contributionDay, contributionDay - 1, contributionDay - 2].filter(d => d > 0 && d <= 31); // Basic filter
                        const notificationIdentifier = `savings-${saving.id}-${currentYear}-${currentMonth + 1}-${contributionDay}`; // Use month 1-12

                        if (notificationDays.includes(currentDay)) {
                            // Check if a notification for this specific saving, for this specific month's contribution day, already exists and is unread
                            const notificationExists = appData.notifications.some(
                                n => n.type === 'savingsReminder' && n.auxInfo === notificationIdentifier && !n.isRead
                            );
                            if (!notificationExists) {
                                addNotification({ 
                                    title: `Lembrete de Guardar!`, 
                                    message: `Hora de guardar ${formatCurrency(amount || 0)} para "${saving.name}".`, 
                                    type: 'savingsReminder', 
                                    relatedId: saving.id, 
                                    auxInfo: notificationIdentifier, // Unique identifier for this specific notification event
                                    actionScreen: 'savings' 
                                });
                            }
                        }
                    }
                });
            }

            function updateNotificationBadge() {
                if (!notificationBadgeEl) return;
                const unreadCount = appData.notifications.filter(n => !n.isRead).length;
                notificationBadgeEl.textContent = unreadCount > 0 ? unreadCount : '';
                notificationBadgeEl.style.display = unreadCount > 0 ? 'flex' : 'none';
            }

            function formatNotificationTime(isoDateString) {
                const date = new Date(isoDateString); const now = new Date();
                const diffSeconds = Math.round((now.getTime() - date.getTime()) / 1000); 
                const diffMinutes = Math.round(diffSeconds / 60);
                const diffHours = Math.round(diffMinutes / 60); 
                const diffDays = Math.round(diffHours / 24);

                if (diffSeconds < 60) return `agora`; 
                if (diffMinutes < 60) return `${diffMinutes} min atrás`;
                if (diffHours < 24) return `${diffHours}h atrás`; 
                if (diffDays === 1) return `ontem`;
                if (diffDays < 7) return `${diffDays}d atrás`; 
                return date.toLocaleDateString('pt-BR');
            }

            function renderNotifications() {
                if (!notificationListContainer) return;
                notificationListContainer.innerHTML = ''; // Clear
                const notificationsToDisplay = appData.notifications.sort((a,b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());

                if (notificationsToDisplay.length === 0) {
                    notificationListContainer.innerHTML = `<div class="notification-empty-state"><svg viewBox="0 0 24 24"><use xlink:href="#icon-notification"></use></svg><p>Nenhuma notificação nova.</p></div>`; 
                    return;
                }
                notificationsToDisplay.forEach(n => {
                    const card = document.createElement('div');
                    card.className = `notification-card ${n.isRead ? 'is-read' : ''}`; 
                    card.dataset.notificationId = n.id;
                    card.innerHTML = `
                        <div class="notification-card-header">
                            <h4 class="notification-card-title">${n.title}</h4>
                            <span class="notification-card-time">${formatNotificationTime(n.createdAt)}</span>
                        </div>
                        <p class="notification-card-message">${n.message}</p>
                        ${!n.isRead ? `<div class="notification-card-actions"><button class="action-button mark-read" data-id="${n.id}" style="background-color: var(--action-button-mark-bg); color: var(--action-button-mark-fg);"><svg><use xlink:href="#icon-check"></use></svg> Marcar lida</button></div>` : ''}
                    `;
                    card.addEventListener('click', (event) => { 
                        if (!event.target.closest('.mark-read')) { 
                            markNotificationAsRead(n.id); 
                            if (n.actionScreen) { 
                                navigateTo(n.actionScreen); 
                                closeNotificationSidenav(); 
                            } 
                        } 
                    });
                    const markReadButton = card.querySelector('.mark-read');
                    if (markReadButton) {
                        markReadButton.addEventListener('click', (e) => { 
                            e.stopPropagation(); 
                            markNotificationAsRead(n.id); 
                        });
                    }
                    notificationListContainer.appendChild(card);
                });
            }

            function markNotificationAsRead(notificationId) {
                const notification = appData.notifications.find(n => n.id === notificationId);
                if (notification && !notification.isRead) { 
                    notification.isRead = true; 
                    saveData(); 
                    updateNotificationBadge(); 
                    renderNotifications(); // Re-render to update visual state
                }
            }

            function markAllNotificationsAsRead() {
                let changed = false; 
                appData.notifications.forEach(n => { if (!n.isRead) { n.isRead = true; changed = true; } });
                if (changed) { saveData(); updateNotificationBadge(); renderNotifications(); }
            }

            function openNotificationSidenav() { 
                if (notificationSidenav && notificationOverlay) { 
                    renderNotifications(); 
                    notificationSidenav.classList.add('open'); 
                    notificationOverlay.classList.add('active'); 
                } 
            }
            function closeNotificationSidenav() { 
                if (notificationSidenav && notificationOverlay) { 
                    notificationSidenav.classList.remove('open'); 
                    notificationOverlay.classList.remove('active'); 
                } 
            }

            if (notificationButton) notificationButton.addEventListener('click', openNotificationSidenav);
            if (closeNotificationSidenavButton) closeNotificationSidenavButton.addEventListener('click', closeNotificationSidenav);
            if (notificationOverlay) notificationOverlay.addEventListener('click', closeNotificationSidenav); // For main overlay as well
            if (markAllNotificationsReadButton) markAllNotificationsReadButton.addEventListener('click', markAllNotificationsAsRead);
            
            // --- UI Update Functions (Dashboard, Lists) ---
            function updateDashboard() { 
                const monthlyIncomeDisplay = document.querySelector('.main-summary-card-value span');
                if (monthlyIncomeDisplay) monthlyIncomeDisplay.textContent = formatCurrency(appData.monthlyIncome);
                const totalIncome = appData.incomes.reduce((sum, income) => sum + Number(income.value), 0);
                const totalFixedExpenses = appData.fixedExpenses.reduce((sum, expense) => sum + Number(expense.value), 0);
                const totalExpenses = appData.expenses.reduce((sum, expense) => sum + Number(expense.value), 0);
                const totalSavings = appData.savings.reduce((sum, saving) => sum + Number(saving.current), 0);
                
                const incomeCardValue = document.querySelector('.quick-access-card[data-screen="income"] .card-value');
                if (incomeCardValue) incomeCardValue.textContent = `+ ${formatCurrency(totalIncome)}`;
                const fixedExpensesCardValue = document.querySelector('.quick-access-card[data-screen="fixed-expenses"] .card-value');
                if (fixedExpensesCardValue) fixedExpensesCardValue.textContent = `${formatCurrency(totalFixedExpenses)} /mês`;
                const expensesCardValue = document.querySelector('.quick-access-card[data-screen="expenses"] .card-value');
                if (expensesCardValue) expensesCardValue.textContent = `- ${formatCurrency(totalExpenses)}`;
                const savingsCardValue = document.querySelector('.quick-access-card[data-screen="savings"] .card-value');
                if (savingsCardValue) savingsCardValue.textContent = formatCurrency(totalSavings);
                
                const totalSpent = totalFixedExpenses + totalExpenses;
                const remaining = Number(appData.monthlyIncome) - totalSpent;
                const spentValueDisplay = document.querySelector('.consumption-total-value.spent');
                if (spentValueDisplay) spentValueDisplay.textContent = formatCurrency(totalSpent);
                const remainingValueDisplay = document.querySelector('.consumption-total-value.remaining');
                if (remainingValueDisplay) remainingValueDisplay.textContent = formatCurrency(remaining);
                const savingsTotalValueDisplay = document.querySelector('.savings-total-value');
                if (savingsTotalValueDisplay) savingsTotalValueDisplay.textContent = formatCurrency(totalSavings);
            }

            function updateIncomeList() { 
                const incomeList = document.getElementById('incomeList'); if (!incomeList) return; 
                incomeList.innerHTML = '';
                if (appData.incomes.length === 0) { incomeList.innerHTML = '<div class="item-card">Nenhuma receita cadastrada.</div>'; return; }
                appData.incomes.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime()).forEach(income => {
                    const incomeCard = document.createElement('div'); incomeCard.className = 'item-card';
                    incomeCard.innerHTML = `
                        <div class="item-header"><div class="item-title">${income.name}</div><div class="item-value">${formatCurrency(income.value)}</div></div>
                        <div class="item-details">Recebido em: ${formatDate(income.date)}</div>
                        <div class="item-actions"><button class="action-button delete" data-id="${income.id}"><svg><use xlink:href="#icon-delete"></use></svg>Excluir</button></div>`;
                    incomeList.appendChild(incomeCard);
                    incomeCard.querySelector('.delete').addEventListener('click', function() { 
                        const id = parseInt(this.getAttribute('data-id')); 
                        appData.incomes = appData.incomes.filter(item => item.id !== id); 
                        saveData(); updateDashboard(); updateIncomeList(); 
                    });
                });
            }

            function updateFixedExpensesList() { 
                const fixedExpensesList = document.getElementById('fixedExpensesList'); if (!fixedExpensesList) return; 
                fixedExpensesList.innerHTML = '';
                if (appData.fixedExpenses.length === 0) { fixedExpensesList.innerHTML = '<div class="item-card">Nenhuma conta fixa cadastrada.</div>'; return; }
                appData.fixedExpenses.sort((a,b) => new Date(a.dueDate).getTime() - new Date(b.dueDate).getTime()).forEach(expense => {
                    const expenseCard = document.createElement('div'); expenseCard.className = 'item-card';
                    expenseCard.innerHTML = `
                        <div class="item-header"><div class="item-title">${expense.name}</div><div class="item-value">${formatCurrency(expense.value)}</div></div>
                        <div class="item-details">Vencimento: ${formatDate(expense.dueDate)} ${expense.paid ? '• <span style="color: var(--text-accent-neon-green);">Paga</span>' : '• <span style="color: var(--text-accent-orange);">Pendente</span>'}</div>
                        <div class="item-actions">
                            <button class="action-button delete" data-id="${expense.id}"><svg><use xlink:href="#icon-delete"></use></svg>Excluir</button>
                            ${!expense.paid ? 
                                `<button class="action-button mark" data-id="${expense.id}"><svg><use xlink:href="#icon-check"></use></svg>Marcar Paga</button>` : 
                                `<button class="action-button mark" data-id="${expense.id}" style="background-color: var(--action-button-delete-bg); color: var(--action-button-delete-fg);"><svg><use xlink:href="#icon-close"></use></svg>Marcar Pendente</button>`
                            }
                        </div>`;
                    fixedExpensesList.appendChild(expenseCard);
                    expenseCard.querySelector('.delete').addEventListener('click', function() { 
                        const id = parseInt(this.getAttribute('data-id')); 
                        appData.fixedExpenses = appData.fixedExpenses.filter(item => item.id !== id); 
                        saveData(); updateDashboard(); updateFixedExpensesList(); checkAndGenerateNotifications(); 
                    });
                    expenseCard.querySelector('.mark').addEventListener('click', function() { 
                        const id = parseInt(this.getAttribute('data-id')); 
                        const expenseItem = appData.fixedExpenses.find(item => item.id === id); 
                        if (expenseItem) { 
                            expenseItem.paid = !expenseItem.paid; 
                            saveData(); updateDashboard(); updateFixedExpensesList(); checkAndGenerateNotifications(); 
                        } 
                    });
                });
            }

            function updateExpensesList() { 
                const expensesList = document.getElementById('expensesList'); if(!expensesList) return; 
                expensesList.innerHTML = '';
                if (appData.expenses.length === 0) { expensesList.innerHTML = '<div class="item-card">Nenhum gasto cadastrado.</div>'; return; }
                const categoryNames = { food: 'Alimentação', transport: 'Transporte', leisure: 'Lazer', health: 'Saúde', education: 'Educação', other: 'Outros' };
                appData.expenses.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime()).forEach(expense => {
                    const expenseCard = document.createElement('div'); expenseCard.className = 'item-card';
                    expenseCard.innerHTML = `
                        <div class="item-header"><div class="item-title">${expense.name}</div><div class="item-value">${formatCurrency(expense.value)}</div></div>
                        <div class="item-details">Categoria: ${categoryNames[expense.category] || 'Outros'} • ${formatDate(expense.date)}</div>
                        <div class="item-actions"><button class="action-button delete" data-id="${expense.id}"><svg><use xlink:href="#icon-delete"></use></svg>Excluir</button></div>`;
                    expensesList.appendChild(expenseCard);
                    expenseCard.querySelector('.delete').addEventListener('click', function() { 
                        const id = parseInt(this.getAttribute('data-id')); 
                        appData.expenses = appData.expenses.filter(item => item.id !== id); 
                        saveData(); updateDashboard(); updateExpensesList(); 
                    });
                });
            }

            function updateSavingsList() { 
                const savingsList = document.getElementById('listaCofrinhosContainer'); if(!savingsList) return; 
                savingsList.innerHTML = '';
                if (appData.savings.length === 0) { savingsList.innerHTML = '<div class="item-card">Nenhum cofrinho cadastrado.</div>'; return; }
                appData.savings.forEach(saving => {
                    const goal = Number(saving.goal);
                    const current = Number(saving.current);
                    const progress = goal > 0 ? (current / goal) * 100 : 0;
                    let recurringInfo = '';
                    if (saving.recurringContribution && saving.recurringContribution.dayOfMonth) {
                        recurringInfo = ` (Guarda R$ ${formatCurrency(saving.recurringContribution.amount || 0)} todo dia ${saving.recurringContribution.dayOfMonth})`;
                    }
                    const savingCard = document.createElement('div'); savingCard.className = 'savings-item';
                    savingCard.innerHTML = `
                        <div class="savings-item-header"><div class="savings-item-title">${saving.name}${recurringInfo}</div><div class="savings-item-value">${formatCurrency(current)} / ${formatCurrency(goal)}</div></div>
                        <div class="savings-progress-container"><div class="savings-progress-bar" style="width: ${Math.min(progress, 100)}%"></div></div>
                        <div class="item-actions">
                            <button class="action-button mark" data-id="${saving.id}"><svg><use xlink:href="#icon-add"></use></svg>Adicionar Valor</button>
                            <button class="action-button edit" data-id="${saving.id}"><svg><use xlink:href="#icon-edit"></use></svg>Editar Meta/Rec.</button>
                            <button class="action-button delete" data-id="${saving.id}"><svg><use xlink:href="#icon-delete"></use></svg>Excluir</button>
                        </div>`;
                    savingsList.appendChild(savingCard);
                    
                    savingCard.querySelector('.delete').addEventListener('click', function() { 
                        const id = parseInt(this.getAttribute('data-id')); 
                        appData.savings = appData.savings.filter(item => item.id !== id); 
                        saveData(); updateDashboard(); updateSavingsList(); checkAndGenerateNotifications(); 
                    });
                    
                    savingCard.querySelector('.mark').addEventListener('click', function() { 
                        const id = parseInt(this.getAttribute('data-id')); 
                        const savingItem = appData.savings.find(item => item.id === id); 
                        if (savingItem) { 
                            const amountStr = prompt('Quanto deseja adicionar?', '0'); 
                            if (amountStr === null) return; 
                            const amount = parseFloat(amountStr.replace(',', '.')) || 0; 
                            if (amount > 0) { 
                                savingItem.current = Number(savingItem.current) + amount; 
                                saveData(); updateDashboard(); updateSavingsList(); checkAndGenerateNotifications(); // Check if goal met
                            } else if (amount < 0) { 
                                alert("Não é possível adicionar valores negativos."); 
                            } 
                        } 
                    });

                    savingCard.querySelector('.edit').addEventListener('click', function() { 
                        const id = parseInt(this.getAttribute('data-id')); 
                        const savingItem = appData.savings.find(item => item.id === id); 
                        if (savingItem) { 
                            const currentGoal = savingItem.goal.toString().replace('.',',');
                            const newGoalStr = prompt(`Nova meta (atual: ${currentGoal}, deixe em branco para não alterar):`, currentGoal);
                            if (newGoalStr !== null) {
                                if (newGoalStr.trim() !== "") {
                                    const newGoal = parseFloat(newGoalStr.replace(',', '.')) || 0;
                                    if (newGoal >= 0) savingItem.goal = newGoal; 
                                    else alert("A meta deve ser positiva ou zero.");
                                }

                                const currentRecDay = savingItem.recurringContribution?.dayOfMonth || '';
                                const currentRecAmount = savingItem.recurringContribution?.amount?.toString().replace('.',',') || '0';

                                const recurringDayStr = prompt(`Dia do mês para guardar (1-31, atual: ${currentRecDay}, deixe em branco para remover recorrência):`, currentRecDay);
                                if (recurringDayStr !== null) {
                                    if (recurringDayStr.trim() === "") {
                                        delete savingItem.recurringContribution; 
                                    } else {
                                        const recurringDay = parseInt(recurringDayStr);
                                        if (recurringDay >= 1 && recurringDay <= 31) {
                                            const recurringAmountStr = prompt(`Valor a guardar mensalmente (atual: ${currentRecAmount}, deixe em branco para R$0):`, currentRecAmount);
                                            if (recurringAmountStr !== null) {
                                                const recurringAmount = parseFloat(recurringAmountStr.replace(',', '.')) || 0;
                                                if (recurringAmount >= 0) {
                                                    savingItem.recurringContribution = { dayOfMonth: recurringDay, amount: recurringAmount };
                                                } else { alert("Valor recorrente deve ser positivo ou zero."); }
                                            }
                                        } else { alert("Dia do mês inválido (1-31)."); }
                                    }
                                }
                                saveData(); updateDashboard(); updateSavingsList(); checkAndGenerateNotifications();
                            }
                        } 
                    });
                });
            }

            // --- Initial UI Population & Event Listeners Setup ---
            updateDashboard(); 
            updateIncomeList(); 
            updateFixedExpensesList(); 
            updateExpensesList(); 
            updateSavingsList();

            const menuButton = document.getElementById('menuButton'); 
            const closeSidenavButton = document.getElementById('closeSidenavButton'); 
            const overlay = document.getElementById('overlay'); 
            const sidenav = document.getElementById('appSidenav'); 
            const sidenavLinks = document.querySelectorAll('.sidenav-link'); 
            const backButtons = document.querySelectorAll('.back-button'); 
            const quickAccessCards = document.querySelectorAll('.quick-access-card');

            if (menuButton && sidenav && overlay) { 
                menuButton.addEventListener('click', function() { 
                    sidenav.classList.add('open'); 
                    overlay.classList.add('active'); 
                }); 
            }
            function closeSidenav() { 
                if (sidenav && overlay) { 
                    sidenav.classList.remove('open'); 
                    overlay.classList.remove('active'); 
                } 
            }
            if (closeSidenavButton) closeSidenavButton.addEventListener('click', closeSidenav); 
            // Make sure the main overlay also closes the notification sidenav if it's open
            if (overlay) {
                overlay.addEventListener('click', () => {
                    closeSidenav(); // Closes left sidenav
                    // No need to explicitly close notification sidenav here, as its own overlay handles it
                });
            }
            
            function navigateTo(screenId) { 
                document.querySelectorAll('.app-screen').forEach(screen => screen.classList.remove('active')); 
                const targetScreen = document.getElementById(screenId); 
                if (targetScreen) targetScreen.classList.add('active'); 
                sidenavLinks.forEach(link => { 
                    link.classList.remove('active'); 
                    if (link.getAttribute('data-screen') === screenId) link.classList.add('active'); 
                }); 
                closeSidenav(); 
                closeNotificationSidenav(); // Close notification panel on navigation
            }

            sidenavLinks.forEach(link => { 
                link.addEventListener('click', function(e) { 
                    e.preventDefault(); 
                    const screenId = this.getAttribute('data-screen'); 
                    navigateTo(screenId); 
                }); 
            });
            backButtons.forEach(button => { 
                button.addEventListener('click', function() { 
                    const screenId = this.getAttribute('data-screen'); 
                    navigateTo(screenId); 
                }); 
            });
            quickAccessCards.forEach(card => { 
                card.addEventListener('click', function() { 
                    const screenId = this.getAttribute('data-screen'); 
                    navigateTo(screenId); 
                }); 
            });

            // Modals & Forms Event Listeners
            const editIncomeButton = document.getElementById('editIncomeButton'); 
            const editIncomeModal = document.getElementById('editIncomeModal'); 
            const closeIncomeModal = document.getElementById('closeIncomeModal'); 
            const saveIncomeButton = document.getElementById('saveIncomeButton'); 
            const monthlyIncomeInput = document.getElementById('monthlyIncome');

            if (editIncomeButton && editIncomeModal && monthlyIncomeInput) { 
                editIncomeButton.addEventListener('click', function() { 
                    monthlyIncomeInput.value = appData.monthlyIncome > 0 ? appData.monthlyIncome.toString().replace('.',',') : '';
                    editIncomeModal.classList.add('active'); 
                }); 
            }
            if (closeIncomeModal && editIncomeModal) {
                closeIncomeModal.addEventListener('click', function() { 
                    editIncomeModal.classList.remove('active'); 
                });
            }
            if (saveIncomeButton && monthlyIncomeInput && editIncomeModal) { 
                saveIncomeButton.addEventListener('click', function() { 
                    const newIncome = parseFloat(monthlyIncomeInput.value.replace(',', '.')) || 0; 
                    appData.monthlyIncome = newIncome; 
                    saveData(); 
                    updateDashboard(); 
                    editIncomeModal.classList.remove('active'); 
                }); 
            }

            const addIncomeButton = document.getElementById('addIncomeButton');
            if (addIncomeButton) { 
                addIncomeButton.addEventListener('click', function() { 
                    const nameInput = document.getElementById('incomeName'); 
                    const valueInput = document.getElementById('incomeValue'); 
                    const dateInput = document.getElementById('incomeDate'); 
                    const name = nameInput.value.trim(); 
                    const value = parseFloat(valueInput.value.replace(',', '.')) || 0; 
                    const date = dateInput.value; 
                    if (name && value > 0 && date) { 
                        appData.incomes.push({ id: Date.now(), name, value, date }); 
                        saveData(); updateDashboard(); updateIncomeList(); 
                        nameInput.value = ''; valueInput.value = ''; dateInput.value = ''; 
                    } else {
                        alert("Por favor, preencha todos os campos da receita com valores válidos.");
                    } 
                }); 
            }
            
            const addFixedExpenseButton = document.getElementById('addFixedExpenseButton');
            if(addFixedExpenseButton) { 
                addFixedExpenseButton.addEventListener('click', function() { 
                    const nameInput = document.getElementById('fixedExpenseName'); 
                    const valueInput = document.getElementById('fixedExpenseValue'); 
                    const dueDateInput = document.getElementById('fixedExpenseDueDate'); 
                    const name = nameInput.value.trim(); 
                    const value = parseFloat(valueInput.value.replace(',', '.')) || 0; 
                    const dueDate = dueDateInput.value; 
                    if (name && value > 0 && dueDate) { 
                        appData.fixedExpenses.push({ id: Date.now(), name, value, dueDate, paid: false }); 
                        saveData(); updateDashboard(); updateFixedExpensesList(); checkAndGenerateNotifications(); 
                        nameInput.value = ''; valueInput.value = ''; dueDateInput.value = ''; 
                    } else {
                         alert("Por favor, preencha todos os campos da conta fixa com valores válidos.");
                    } 
                }); 
            }

            const addExpenseButton = document.getElementById('addExpenseButton'); 
            const addExpenseFloatingButton = document.getElementById('addExpenseFloatingButton'); 
            const expenseForm = document.getElementById('addExpenseForm');
            function handleAddExpense() { 
                const nameInput = document.getElementById('expenseName'); 
                const valueInput = document.getElementById('expenseValue'); 
                const categoryInput = document.getElementById('expenseCategory'); 
                const dateInput = document.getElementById('expenseDate'); 
                const name = nameInput.value.trim(); 
                const value = parseFloat(valueInput.value.replace(',', '.')) || 0; 
                const category = categoryInput.value; 
                const date = dateInput.value; 
                if (name && value > 0 && category && date) { 
                    appData.expenses.push({ id: Date.now(), name, value, category, date }); 
                    saveData(); updateDashboard(); updateExpensesList(); 
                    if(expenseForm) expenseForm.reset(); 
                    dateInput.value = ''; // Explicitly clear date as reset might not work on all browsers for date
                } else {
                    alert("Por favor, preencha todos os campos do gasto com valores válidos.");
                } 
            }
            if(addExpenseButton) addExpenseButton.addEventListener('click', handleAddExpense);
            if(addExpenseFloatingButton) { 
                addExpenseFloatingButton.addEventListener('click', function() { 
                    navigateTo('expenses'); 
                    const expenseNameInput = document.getElementById('expenseName'); 
                    if(expenseNameInput) expenseNameInput.focus(); 
                }); 
            }

            const addSavingsButton = document.getElementById('addSavingsButton');
            const savingsForm = document.getElementById('addSavingsForm');
            if(addSavingsButton && savingsForm) { 
                addSavingsButton.addEventListener('click', function() { 
                    const nameInput = document.getElementById('savingsName'); 
                    const goalInput = document.getElementById('savingsGoal');
                    const recurringDayInput = document.getElementById('savingsRecurringDay');
                    const recurringAmountInput = document.getElementById('savingsRecurringAmount');

                    const name = nameInput.value.trim(); 
                    const goal = parseFloat(goalInput.value.replace(',', '.')) || 0; 
                    const recurringDay = recurringDayInput.value.trim() ? parseInt(recurringDayInput.value) : null;
                    const recurringAmount = recurringAmountInput.value.trim() ? parseFloat(recurringAmountInput.value.replace(',', '.')) : null;

                    if (name && goal > 0) { 
                        const newSaving = { id: Date.now(), name, goal: Number(goal), current: 0 };
                        if (recurringDay && recurringDay >= 1 && recurringDay <= 31 && recurringAmount !== null && recurringAmount >= 0) {
                            newSaving.recurringContribution = { dayOfMonth: recurringDay, amount: Number(recurringAmount) };
                        }
                        appData.savings.push(newSaving); 
                        saveData(); updateDashboard(); updateSavingsList(); checkAndGenerateNotifications();
                        savingsForm.reset(); 
                    } else { 
                        alert("Nome do cofrinho e meta (maior que zero) são obrigatórios."); 
                    } 
                }); 
            }
            // Final initialization calls
            initializeTheme(); // Called again here to ensure notifications are checked after all data potentially loaded and parsed.
                               // Note: initializeTheme also calls checkAndGenerateNotifications and updateNotificationBadge.
                               // It was already called after localStorage load, this might be redundant unless appData was further modified.
                               // For safety, ensure it's logically placed for one effective initial run.
                               // Corrected: initializeTheme() was already called after localStorage. This second call is removed.
        });
    </script>
</body>
</html>
